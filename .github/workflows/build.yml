name: æ„å»º KDENGINE APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # ğŸ”¥ å¿…é¡»ç”¨ Java 11ï¼ˆAndroid Gradle Plugin è¦æ±‚ï¼‰
      - name: è®¾ç½® JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: æŸ¥çœ‹å½“å‰ç›®å½•æ–‡ä»¶
        run: ls -la

      - name: è§£å‹æºç 
        run: |
          unzip -o KD_ENGINE-src.zip
          rm -f KD_ENGINE-src.zip

      - name: æŸ¥çœ‹è§£å‹åæ ¹ç›®å½•
        run: ls -la

      - name: èµ‹äºˆæ‰§è¡Œæƒé™
        run: chmod +x gradlew

      # ğŸ”¥ å¼ºåˆ¶ä½¿ç”¨ Gradle 7.2ï¼ˆä¸ Java 11 å®Œç¾å…¼å®¹ï¼‰
      - name: ä½¿ç”¨ Gradle 7.2
        run: ./gradlew wrapper --gradle-version 7.2 --distribution-type bin

      # ğŸ”¥ ğŸ”¥ ğŸ”¥ å…³é”®ä¿®å¤ï¼šå¼ºåˆ¶é™çº§ Android Gradle æ’ä»¶åˆ° 4.2.1
      - name: ä¿®å¤ build.gradle æ’ä»¶ç‰ˆæœ¬
        run: |
          sed -i 's/com.android.tools.build:gradle:.*/com.android.tools.build:gradle:4.2.1/' app/build.gradle
          sed -i 's/classpath .*android.*/classpath "com.android.tools.build:gradle:4.2.1"/' build.gradle

      - name: æ¥å— Android SDK è®¸å¯è¯
        run: |
          mkdir -p $ANDROID_SDK_ROOT/licenses
          echo "8933bad161af4178b1185d1a37fbf41ea5269c55" > $ANDROID_SDK_ROOT/licenses/android-sdk-license
          echo "d56f5187479451eabf01fb78af6dfcb131a6481e" > $ANDROID_SDK_ROOT/licenses/android-sdk-arm-dbt-license
          echo "84831b9409646a918e30573bab4c9c91346d8abd" > $ANDROID_SDK_ROOT/licenses/android-sdk-preview-license

      # ğŸ”¥ ç¼–è¯‘ APKï¼ˆä½¿ç”¨ --no-daemon é¿å…ç¼“å­˜é—®é¢˜ï¼‰
      - name: ç¼–è¯‘ APK
        run: ./gradlew assembleDebug --no-daemon --stacktrace

      - name: ä¸Šä¼  APK
        uses: actions/upload-artifact@v4
        with:
          name: KDENGINE-debug
          path: app/build/outputs/apk/debug/app-debug.apk
